@require: list

@import: expect
@import: test-run-result

module TestCase : sig

  type t

  val describe : string -> t list -> t
  val test : string -> (unit -> ExpectResult.t) -> t
  val run : t -> TestRunResult.t

end = struct

  type s = (| name : string; test-runner : unit -> TestRunResult.t |)
  type t = s

  let test name test-body =
    let test-runner () =
      let result = test-body () in
      if result |> ExpectResult.is-pass then
        TestRunResult.make (| run = 1; success = 1 |)
      else
        TestRunResult.make (| run = 1; success = 0 |) in
    (|
      name = name;
      test-runner = test-runner;
    |)

  let run test-case = test-case#test-runner ()

  let describe name test-cases =
    let combine-result a b =
      open TestRunResult in
      make (|
        run = (count-run a + count-run b);
        success = (count-success a + count-success b);
      |) in
    let empty-result =
      TestRunResult.make (| run = 0; success = 0 |) in
    let test-runner () =
      test-cases
      |> List.map run
      |> List.fold-left combine-result empty-result in
    (|
      name = name;
      test-runner = test-runner;
    |)

end
